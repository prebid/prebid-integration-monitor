#!/bin/bash

# Pre-commit hook to prevent GitHub range processing bugs and similar issues
set -e

echo "ğŸ” Running comprehensive pre-commit validation..."

# Run the complete validation pipeline
echo "ğŸš€ Running complete validation (build, lint, format, docs, tests, integration)..."
npm run validate:all
if [ $? -ne 0 ]; then
    echo "âŒ Comprehensive validation failed. Please fix all issues before committing."
    echo "   This includes: TypeScript errors, linting issues, formatting, docs sync, tests, and integration tests."
    exit 1
fi

# 7. Check for common anti-patterns that could cause range processing bugs
echo "ğŸ” Checking for range processing anti-patterns..."

# Check for double range application patterns
if grep -r "options\.range.*allUrls\.slice" src/ --include="*.ts" --exclude-dir="__tests__"; then
    echo "âš ï¸  WARNING: Found potential double range application pattern. Review carefully."
    echo "   This pattern caused the GitHub range bug. Ensure range is only applied once."
fi

# Check for GitHub source type handling
if grep -r "urlSourceType.*GitHub" src/ --include="*.ts" --exclude-dir="__tests__" | grep -v "!==.*GitHub"; then
    echo "âœ… Good: Found GitHub source type handling."
else
    echo "âš ï¸  WARNING: No GitHub source type differentiation found. This could cause range processing issues."
fi

# Check for range optimization usage
if grep -r "rangeOptions" src/ --include="*.ts" --exclude-dir="__tests__"; then
    echo "âœ… Good: Found range optimization usage."
else
    echo "âš ï¸  WARNING: No range optimization found. Large ranges may cause memory issues."
fi

# 8. Validate test coverage for critical functions
echo "ğŸ¯ Validating test coverage for critical functions..."

critical_functions=(
    "fetchUrlsFromGitHub"
    "processContentWithRangeOptimization"
    "processPrebidWithOptions"
)

for func in "${critical_functions[@]}"; do
    if grep -r "describe.*$func\|it.*$func" src/__tests__/ --include="*.ts" > /dev/null; then
        echo "âœ… $func has test coverage"
    else
        echo "âš ï¸  WARNING: $func may lack adequate test coverage"
    fi
done

# 9. Check for proper error handling in range processing
echo "ğŸ›¡ï¸  Checking error handling patterns..."

if grep -r "No URLs to process" src/ --include="*.ts" --exclude-dir="__tests__"; then
    echo "âœ… Found 'No URLs to process' handling - ensure this has proper test coverage"
fi

if grep -r "beyond the total number of URLs" src/ --include="*.ts" --exclude-dir="__tests__"; then
    echo "âœ… Found range boundary checking - good defensive programming"
fi

# 10. Memory usage validation for large range operations
echo "ğŸ’¾ Validating memory usage patterns..."

if grep -r "process\.memoryUsage" src/__tests__/ --include="*.ts" > /dev/null; then
    echo "âœ… Found memory usage testing - good for large range operations"
else
    echo "âš ï¸  WARNING: No memory usage testing found. Large ranges could cause memory issues."
fi

echo ""
echo "âœ… Pre-commit validation completed successfully!"
echo "ğŸš€ Ready to commit. All integration tests passed and anti-patterns checked."
echo ""